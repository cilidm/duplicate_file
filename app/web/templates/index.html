<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DuplicateHunter - 重复文件检测工具</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.bootcdn.net/ajax/libs/bootstrap-icons/1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .scan-progress {
            display: none;
        }
        .file-item {
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
            padding: 0.75rem;
        }
        .file-path {
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            word-break: break-all;
        }
        .file-name {
            font-weight: bold;
            color: #0066cc;
        }
        .file-dir {
            color: #666;
            font-size: 0.85rem;
        }
        .file-diff {
            background-color: #ff6b6b;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.9em;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .file-item:hover {
            background-color: #f8f9fa;
            border-color: #007bff;
        }
        .duplicate-group {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .duplicate-group {
            border: 2px solid #ffc107;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            background-color: #fff3cd;
        }
        .group-header {
            background-color: #ffc107;
            color: #000;
            padding: 0.75rem;
            font-weight: bold;
            border-radius: 0.5rem 0.5rem 0 0;
        }
        .loading-spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- 侧边栏 -->
            <div class="col-md-3 bg-light p-3">
                <h4><i class="bi bi-search"></i> DuplicateHunter</h4>
                <hr>
                
                <!-- 扫描配置 -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h6><i class="bi bi-gear"></i> 扫描配置</h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">扫描目录</label>
                            <input type="text" class="form-control" id="scanDirectory" placeholder="/path/to/directory">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">哈希算法</label>
                            <select class="form-select" id="algorithm">
                                <option value="md5">MD5 (快速)</option>
                                <option value="sha1">SHA1 (平衡)</option>
                                <option value="sha256">SHA256 (安全)</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">最小文件大小 (字节)</label>
                            <input type="number" class="form-control" id="minSize" value="1024">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">线程数</label>
                            <input type="number" class="form-control" id="threads" value="4" min="1" max="16">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">文件扩展名过滤 (可选)</label>
                            <input type="text" class="form-control" id="extensions" placeholder=".jpg,.png,.mp4">
                            <small class="form-text text-muted">用逗号分隔，留空表示所有文件</small>
                        </div>
                        
                        <button class="btn btn-primary w-100" id="startScan">
                            <i class="bi bi-play-fill"></i> 开始扫描
                        </button>
                        
                        <button class="btn btn-danger w-100 mt-2" id="stopScan" style="display: none;">
                            <i class="bi bi-stop-fill"></i> 停止扫描
                        </button>
                    </div>
                </div>
                
                <!-- 扫描进度 -->
                <div class="card scan-progress" id="progressCard">
                    <div class="card-header">
                        <h6><i class="bi bi-clock"></i> 扫描进度</h6>
                    </div>
                    <div class="card-body">
                        <div class="progress mb-2">
                            <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                        </div>
                        <small id="progressText">准备中...</small>
                        <div class="mt-2">
                            <small class="text-muted" id="progressDetails"></small>
                        </div>
                    </div>
                </div>
                
                <!-- 统计信息 -->
                <div class="card" id="statsCard" style="display: none;">
                    <div class="card-header">
                        <h6><i class="bi bi-bar-chart"></i> 统计信息</h6>
                    </div>
                    <div class="card-body" id="statsContent">
                    </div>
                </div>
            </div>
            
            <!-- 主内容区 -->
            <div class="col-md-9 p-3">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5>扫描结果</h5>
                    <div>
                        <button class="btn btn-outline-primary btn-sm" id="generateReport" style="display: none;">
                            <i class="bi bi-file-earmark-text"></i> 生成报告
                        </button>
                        <button class="btn btn-outline-danger btn-sm" id="batchDelete" style="display: none;">
                            <i class="bi bi-trash"></i> 批量删除
                        </button>
                    </div>
                </div>
                
                <div id="resultsContainer">
                    <div class="text-center text-muted py-5">
                        <i class="bi bi-folder2-open" style="font-size: 3rem;"></i>
                        <p class="mt-3">选择目录并开始扫描以查看重复文件</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 报告生成模态框 -->
    <div class="modal fade" id="reportModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">生成报告</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">报告格式</label>
                        <select class="form-select" id="reportFormat">
                            <option value="html">HTML (推荐)</option>
                            <option value="json">JSON</option>
                            <option value="csv">CSV</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="confirmGenerateReport">生成</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.bootcdn.net/ajax/libs/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentScanId = null;
        let scanResults = null;
        let selectedFiles = new Set();
        
        // 高亮文件名差异
        function highlightDifferences(fileName, allFileNames) {
            if (allFileNames.length <= 1) return fileName;
            
            // 找出最长公共前缀
            let commonPrefix = '';
            for (let i = 0; i < fileName.length; i++) {
                const char = fileName[i];
                if (allFileNames.every(name => name[i] === char)) {
                    commonPrefix += char;
                } else {
                    break;
                }
            }
            
            // 找出最长公共后缀
            let commonSuffix = '';
            for (let i = 1; i <= fileName.length; i++) {
                const char = fileName[fileName.length - i];
                if (allFileNames.every(name => name[name.length - i] === char)) {
                    commonSuffix = char + commonSuffix;
                } else {
                    break;
                }
            }
            
            // 提取差异部分
            const prefixLen = commonPrefix.length;
            const suffixLen = commonSuffix.length;
            const diffPart = fileName.substring(prefixLen, fileName.length - suffixLen);
            
            // 如果有差异部分，高亮显示
            if (diffPart) {
                return `${commonPrefix}<span class="file-diff">${diffPart}</span>${commonSuffix}`;
            }
            
            return fileName;
        }
        
        // 开始扫描
        document.getElementById('startScan').addEventListener('click', function() {
            const directory = document.getElementById('scanDirectory').value.trim();
            if (!directory) {
                alert('请输入扫描目录');
                return;
            }
            
            const config = {
                directory: directory,
                algorithm: document.getElementById('algorithm').value,
                min_size: parseInt(document.getElementById('minSize').value) || 1024,
                threads: parseInt(document.getElementById('threads').value) || 4
            };
            
            // 处理扩展名过滤
            const extensions = document.getElementById('extensions').value.trim();
            if (extensions) {
                config.extensions = extensions.split(',').map(ext => ext.trim());
            }
            
            fetch('/api/scan', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('错误: ' + data.error);
                } else {
                    currentScanId = data.scan_id;
                    startProgressMonitoring();
                    toggleScanButtons(true);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('启动扫描失败');
            });
        });
        
        // 停止扫描
        document.getElementById('stopScan').addEventListener('click', function() {
            if (currentScanId) {
                fetch(`/api/scan/${currentScanId}/stop`, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    toggleScanButtons(false);
                    document.getElementById('progressCard').style.display = 'none';
                });
            }
        });
        
        // 切换扫描按钮状态
        function toggleScanButtons(scanning) {
            document.getElementById('startScan').style.display = scanning ? 'none' : 'block';
            document.getElementById('stopScan').style.display = scanning ? 'block' : 'none';
            document.getElementById('progressCard').style.display = scanning ? 'block' : 'none';
        }
        
        // 监控扫描进度
        function startProgressMonitoring() {
            const interval = setInterval(() => {
                if (!currentScanId) {
                    clearInterval(interval);
                    return;
                }
                
                fetch(`/api/scan/${currentScanId}/status`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'running') {
                        updateProgress(data.progress);
                    } else if (data.status === 'completed') {
                        clearInterval(interval);
                        onScanCompleted(data);
                    } else if (data.status === 'error') {
                        clearInterval(interval);
                        onScanError(data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    clearInterval(interval);
                });
            }, 1000);
        }
        
        // 更新进度
        function updateProgress(progress) {
            const percentage = progress.total > 0 ? (progress.current / progress.total * 100) : 0;
            document.getElementById('progressBar').style.width = percentage + '%';
            document.getElementById('progressText').textContent = progress.message;
            document.getElementById('progressDetails').textContent = 
                `${progress.current} / ${progress.total}`;
        }
        
        // 扫描完成
        function onScanCompleted(data) {
            toggleScanButtons(false);
            document.getElementById('progressCard').style.display = 'none';
            
            scanResults = data.result;
            displayResults(data.result);
            displayStatistics(data.statistics);
            
            document.getElementById('generateReport').style.display = 'inline-block';
            document.getElementById('batchDelete').style.display = 'inline-block';
        }
        
        // 扫描错误
        function onScanError(error) {
            toggleScanButtons(false);
            document.getElementById('progressCard').style.display = 'none';
            alert('扫描失败: ' + error);
        }
        
        // 显示结果
        function displayResults(result) {
            const container = document.getElementById('resultsContainer');
            
            if (Object.keys(result.duplicate_groups).length === 0) {
                container.innerHTML = `
                    <div class="text-center text-success py-5">
                        <i class="bi bi-check-circle" style="font-size: 3rem;"></i>
                        <p class="mt-3">太棒了！没有发现重复文件</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            let groupId = 1;
            
            for (const [hash, files] of Object.entries(result.duplicate_groups)) {
                html += `
                    <div class="duplicate-group">
                        <div class="group-header">
                            <i class="bi bi-files"></i> 重复组 #${groupId} - ${files.length} 个文件
                            <small class="float-end">哈希: ${hash.substring(0, 16)}...</small>
                        </div>
                        <div class="p-3">
                `;
                
                // 分析文件名差异
                const fileInfos = files.map(file => {
                    const parts = file.split('/');
                    const fileName = parts[parts.length - 1];
                    const dirPath = parts.slice(0, -1).join('/');
                    return { fullPath: file, fileName, dirPath };
                });
                
                files.forEach((file, index) => {
                    const fileInfo = fileInfos[index];
                    const fileName = fileInfo.fileName;
                    const dirPath = fileInfo.dirPath;
                    
                    // 高亮文件名中的差异部分
                    let highlightedName = fileName;
                    if (files.length > 1) {
                        // 找出所有文件名的公共部分和差异部分
                        const allFileNames = fileInfos.map(f => f.fileName);
                        highlightedName = highlightDifferences(fileName, allFileNames);
                    }
                    
                    html += `
                        <div class="file-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <div class="file-name">${highlightedName}</div>
                                    <div class="file-dir">
                                        <i class="bi bi-folder"></i> ${dirPath}
                                    </div>
                                    <small class="text-muted mt-1">
                                        完整路径: <code>${file}</code>
                                    </small>
                                </div>
                                <div class="ms-3">
                                    <input type="checkbox" class="form-check-input file-checkbox" 
                                           data-file="${file}" ${index > 0 ? 'checked' : ''}>
                                    <button class="btn btn-sm btn-outline-danger ms-2" 
                                            onclick="deleteFile('${file}')">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div></div>';
                groupId++;
            }
            
            container.innerHTML = html;
            
            // 绑定复选框事件
            document.querySelectorAll('.file-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    if (this.checked) {
                        selectedFiles.add(this.dataset.file);
                    } else {
                        selectedFiles.delete(this.dataset.file);
                    }
                });
                
                // 初始化选中状态
                if (checkbox.checked) {
                    selectedFiles.add(checkbox.dataset.file);
                }
            });
        }
        
        // 显示统计信息
        function displayStatistics(stats) {
            const container = document.getElementById('statsContent');
            let html = '';
            
            for (const [key, value] of Object.entries(stats)) {
                html += `
                    <div class="d-flex justify-content-between mb-2">
                        <span>${key}:</span>
                        <strong>${value}</strong>
                    </div>
                `;
            }
            
            container.innerHTML = html;
            document.getElementById('statsCard').style.display = 'block';
        }
        
        // 删除单个文件
        function deleteFile(filePath) {
            if (confirm('确定要删除这个文件吗？\n' + filePath)) {
                fetch('/api/files/delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        files: [filePath],
                        backup_dir: 'backups'
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.results[0].success) {
                        alert('文件删除成功');
                        location.reload(); // 简单刷新页面
                    } else {
                        alert('文件删除失败');
                    }
                });
            }
        }
        
        // 批量删除
        document.getElementById('batchDelete').addEventListener('click', function() {
            if (selectedFiles.size === 0) {
                alert('请选择要删除的文件');
                return;
            }
            
            if (confirm(`确定要删除 ${selectedFiles.size} 个文件吗？`)) {
                fetch('/api/files/delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        files: Array.from(selectedFiles),
                        backup_dir: 'backups'
                    })
                })
                .then(response => response.json())
                .then(data => {
                    const successCount = data.results.filter(r => r.success).length;
                    alert(`成功删除 ${successCount} 个文件`);
                    location.reload();
                });
            }
        });
        
        // 生成报告
        document.getElementById('generateReport').addEventListener('click', function() {
            const modal = new bootstrap.Modal(document.getElementById('reportModal'));
            modal.show();
        });
        
        document.getElementById('confirmGenerateReport').addEventListener('click', function() {
            const format = document.getElementById('reportFormat').value;
            
            fetch('/api/report/generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    scan_id: currentScanId,
                    format: format
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('生成报告失败: ' + data.error);
                } else {
                    // 下载报告
                    window.open(data.download_url, '_blank');
                    bootstrap.Modal.getInstance(document.getElementById('reportModal')).hide();
                }
            });
        });
    </script>
</body>
</html>